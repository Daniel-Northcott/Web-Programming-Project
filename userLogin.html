<html>
	<head>
		<title>User Login</title>
		<link rel="stylesheet" href="/style.css" />
	</head>
	<body>
		<nav class="nav">
			<div class="container nav-inner">
				<a class="logo" href="/">Movie Addicts</a>
				<div class="nav-actions">
					<span id="userEmail" class="user" aria-live="polite"></span>
					<ul class="nav-links">
						<li><a href="/catalog">Catalog</a></li>
						<li><a href="/about">About</a></li>
						<li><a href="/contact">Contact</a></li>
					</ul>
					<a id="loginBtn" class="btn" href="/userLogin" title="User Login">Login</a>
				</div>
			</div>
		</nav>
		<div class="container">
			<h1 id="formTitle">Welcome back</h1>
			<p class="dim" id="formSubtitle">Log in or create an account to save reviews.</p>
			<div class="card">
				<form id="authForm">
					<!-- Registration-only fields wrapper (shown when mode === 'register') -->
					<div id="registerExtra">
						<div class="row">
							<label for="firstName">First Name</label>
							<input id="firstName" name="firstName" type="text" />
						</div>
						<div class="row">
							<label for="lastName">Last Name</label>
							<input id="lastName" name="lastName" type="text" />
						</div>
						<div class="row">
							<label for="username">Username</label>
							<input id="username" name="username" type="text" />
						</div>
					</div>
					<div class="row" id="emailRow">
						<label for="email">Email</label>
						<input id="email" name="email" type="email" />
					</div>
					<div class="row">
						<label for="password">Password</label>
						<input id="password" name="password" type="password" required />
					</div>
					<div class="actions">
						<button type="submit" class="primary" id="loginBtn">Login</button>
						<button type="button" class="secondary" id="toggleModeBtn">Register</button>
						<a href="/" class="ml-auto self-center">Back to home</a>
					</div>
					<div class="msg" id="msg"></div>
				</form>
			</div>
		</div>
		<script>
			(function(){
				const username = localStorage.getItem('userName');
				const loginBtn = document.getElementById('loginBtn');
				const emailEl = document.getElementById('userEmail');
				if (username) {
					emailEl.textContent = username;
					loginBtn.textContent = 'Logout';
					loginBtn.removeAttribute('href');
					loginBtn.onclick = () => { localStorage.removeItem('userName'); location.reload(); };
				} else {
					emailEl.textContent = '';
					loginBtn.textContent = 'Login';
					loginBtn.setAttribute('href', '/userLogin');
					loginBtn.onclick = null;
				}
			})();
			// Authentication form script: toggles between login and registration modes.
			// On successful login sets localStorage userName and redirects to home.
			const form = document.getElementById('authForm');
			const msg = document.getElementById('msg');
			const loginBtn = document.getElementById('loginBtn');
			const toggleModeBtn = document.getElementById('toggleModeBtn');
			const extra = document.getElementById('registerExtra');
			const formTitle = document.getElementById('formTitle');
			const formSubtitle = document.getElementById('formSubtitle');
			let mode = 'login'; // or 'register'

			/**
			 * setMessage
			 * Updates status text (success or error) below the form.
			 * @param {string} text - Message to display
			 * @param {boolean} isError - True for error styling
			 */
			function setMessage(text, isError=false){
				msg.textContent = text;
				msg.style.color = isError ? '#fca5a5' : '#9ca3af';
			}

			/**
			 * post
			 * Helper to send JSON POST requests.
			 * @param {string} url - Endpoint URL
			 * @param {object} data - Payload object
			 * @returns {Promise<object>} - Parsed JSON response
			 */
			async function post(url, data){
				const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
				const body = await res.json().catch(() => ({}));
				if(!res.ok) throw new Error(body.message || 'Request failed');
				return body;
			}

			// Toggle between login and register modes: show/hide extra fields, adjust button labels and headings.
			toggleModeBtn.addEventListener('click', () => {
				mode = mode === 'login' ? 'register' : 'login';
				if (mode === 'register') {
					extra.style.display = 'block';
					loginBtn.textContent = 'Create Account';
					toggleModeBtn.textContent = 'Have an account?';
					formTitle.textContent = 'Create your account';
					formSubtitle.textContent = 'Fill in details to register.';
					setMessage('');
				} else {
					extra.style.display = 'none';
					loginBtn.textContent = 'Login';
					toggleModeBtn.textContent = 'Register';
					formTitle.textContent = 'Welcome back';
					formSubtitle.textContent = 'Log in or create an account to save reviews.';
					setMessage('');
				}
			});

			// Form submit handler: executes login or registration flow based on current mode.
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const email = form.email.value.trim();
				const password = form.password.value;
				const username = (form.username ? form.username.value.trim() : '').toLowerCase();
				const firstName = form.firstName ? form.firstName.value.trim() : '';
				const lastName = form.lastName ? form.lastName.value.trim() : '';
				try {
					if (mode === 'login') {
						setMessage('Signing in...');
						const u = await post('/api/users/login', { username, email, password });
						if (!u.username) throw new Error('Login succeeded but username missing; please register a new account.');
						localStorage.setItem('userName', u.username);
						setMessage('Logged in successfully');
						window.location.href = '/';
					} else {
						setMessage('Creating account...');
						if (!username) throw new Error('Username required');
						await post('/api/users/register', { firstName, lastName, username, email, password });
						setMessage('Account created. You can now log in.');
						mode = 'login';
						extra.style.display = 'none';
						loginBtn.textContent = 'Login';
						toggleModeBtn.textContent = 'Register';
						formTitle.textContent = 'Welcome back';
						formSubtitle.textContent = 'Log in or create an account to save reviews.';
					}
				} catch (err) {
					setMessage(err.message, true);
				}
			});
		</script>
	</body>
	</html>
