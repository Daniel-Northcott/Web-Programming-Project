<html>
	<head>
		<title>User Login</title>
		<style>
			body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0f172a; color:#e5e7eb; margin:0; }
			.container { max-width: 420px; margin: 64px auto; padding: 0 16px; }
			.card { background:#111827; border:1px solid rgba(229,231,235,.06); border-radius:12px; padding:20px; }
			label { display:block; font-size:14px; color:#9ca3af; margin-bottom:6px; }
			input { width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(229,231,235,.08); background:#0b1220; color:#e5e7eb; }
			.row { margin-bottom:14px; }
			.actions { display:flex; gap:10px; }
			button { cursor:pointer; padding:10px 14px; border-radius:8px; border:0; font-weight:600; }
			.primary { background:#22d3ee; color:#051923; }
			.secondary { background:#1f2937; color:#e5e7eb; border:1px solid rgba(229,231,235,.08); }
			.msg { margin-top:10px; font-size:14px; color:#9ca3af; }
			a { color:#22d3ee; text-decoration:none; }
		</style>
	</head>
	<body>
		<div class="container">
			<h1 style="margin:0 0 12px" id="formTitle">Welcome back</h1>
			<p style="margin:0 0 20px;color:#9ca3af" id="formSubtitle">Log in or create an account to save reviews.</p>
			<div class="card">
				<form id="authForm">
					<!-- Registration-only fields wrapper (shown when mode === 'register') -->
					<div id="registerExtra" style="display:none">
						<div class="row">
							<label for="firstName">First Name</label>
							<input id="firstName" name="firstName" type="text" />
						</div>
						<div class="row">
							<label for="lastName">Last Name</label>
							<input id="lastName" name="lastName" type="text" />
						</div>
						<div class="row">
							<label for="username">Username</label>
							<input id="username" name="username" type="text" />
						</div>
					</div>
					<div class="row" id="emailRow">
						<label for="email">Email</label>
						<input id="email" name="email" type="email" />
					</div>
					<div class="row">
						<label for="password">Password</label>
						<input id="password" name="password" type="password" required />
					</div>
					<div class="actions">
						<button type="submit" class="primary" id="loginBtn">Login</button>
						<button type="button" class="secondary" id="toggleModeBtn">Register</button>
						<a href="index.html" style="margin-left:auto;align-self:center;">Back to home</a>
					</div>
					<div class="msg" id="msg"></div>
				</form>
			</div>
		</div>
		<script>
			// Authentication form script: toggles between login and registration modes.
			// On successful login sets localStorage userName and redirects to home.
			const form = document.getElementById('authForm');
			const msg = document.getElementById('msg');
			const loginBtn = document.getElementById('loginBtn');
			const toggleModeBtn = document.getElementById('toggleModeBtn');
			const extra = document.getElementById('registerExtra');
			const formTitle = document.getElementById('formTitle');
			const formSubtitle = document.getElementById('formSubtitle');
			let mode = 'login'; // or 'register'

			/**
			 * setMessage
			 * Updates status text (success or error) below the form.
			 * @param {string} text - Message to display
			 * @param {boolean} isError - True for error styling
			 */
			function setMessage(text, isError=false){
				msg.textContent = text;
				msg.style.color = isError ? '#fca5a5' : '#9ca3af';
			}

			/**
			 * post
			 * Helper to send JSON POST requests.
			 * @param {string} url - Endpoint URL
			 * @param {object} data - Payload object
			 * @returns {Promise<object>} - Parsed JSON response
			 */
			async function post(url, data){
				const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
				const body = await res.json().catch(() => ({}));
				if(!res.ok) throw new Error(body.message || 'Request failed');
				return body;
			}

			// Toggle between login and register modes: show/hide extra fields, adjust button labels and headings.
			toggleModeBtn.addEventListener('click', () => {
				mode = mode === 'login' ? 'register' : 'login';
				if (mode === 'register') {
					extra.style.display = 'block';
					loginBtn.textContent = 'Create Account';
					toggleModeBtn.textContent = 'Have an account?';
					formTitle.textContent = 'Create your account';
					formSubtitle.textContent = 'Fill in details to register.';
					setMessage('');
				} else {
					extra.style.display = 'none';
					loginBtn.textContent = 'Login';
					toggleModeBtn.textContent = 'Register';
					formTitle.textContent = 'Welcome back';
					formSubtitle.textContent = 'Log in or create an account to save reviews.';
					setMessage('');
				}
			});

			// Form submit handler: executes login or registration flow based on current mode.
			form.addEventListener('submit', async (e) => {
				e.preventDefault();
				const email = form.email.value.trim();
				const password = form.password.value;
				const username = (form.username ? form.username.value.trim() : '').toLowerCase();
				const firstName = form.firstName ? form.firstName.value.trim() : '';
				const lastName = form.lastName ? form.lastName.value.trim() : '';
				try {
					if (mode === 'login') {
						setMessage('Signing in...');
						const u = await post('/api/users/login', { username, email, password });
						if (!u.username) throw new Error('Login succeeded but username missing; please register a new account.');
						localStorage.setItem('userName', u.username);
						setMessage('Logged in successfully');
						window.location.href = 'index.html';
					} else {
						setMessage('Creating account...');
						if (!username) throw new Error('Username required');
						await post('/api/users/register', { firstName, lastName, username, email, password });
						setMessage('Account created. You can now log in.');
						mode = 'login';
						extra.style.display = 'none';
						loginBtn.textContent = 'Login';
						toggleModeBtn.textContent = 'Register';
						formTitle.textContent = 'Welcome back';
						formSubtitle.textContent = 'Log in or create an account to save reviews.';
					}
				} catch (err) {
					setMessage(err.message, true);
				}
			});
		</script>
	</body>
	</html>
