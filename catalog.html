<html>
	<head>
		<title>Catalog — Movie Addicts</title>
		<!--
			Page: Catalog
			Purpose: Displays all movies (fetched from /api/movies) with associated reviews and a form to submit new reviews.
			Auth: Shows logged-in username; logout handled client-side via localStorage.
			Layout: Three-column grid per movie (poster | details | reviews + form).
			Accessibility: container uses aria-live for dynamic movie list updates.
		-->
		<link rel="stylesheet" href="/style.css" />
	</head>
	<body>
		<nav class="nav">
			<div class="container nav-inner">
				<a class="logo" href="/">Movie Addicts</a>
				<div class="nav-actions">
					<span id="userEmail" class="user" aria-live="polite"></span>
					<ul class="nav-links">
						<li><a href="/catalog">Catalog</a></li>
						<li><a href="/about">About</a></li>
						<li><a href="/contact">Contact</a></li>
					</ul>
					<a id="loginBtn" class="btn" href="/userLogin" title="User Login">Login</a>
				</div>
			</div>
		</nav>
		<div class="container">
			<h1>Catalog</h1>
			<div id="grid" class="list" aria-live="polite"></div>
		</div>
		<script>
			/**
			 * updateAuthUI
			 * Reflects authentication state in navigation: shows username and converts Login link to Logout.
			 * Source of truth is localStorage key 'userName'.
			 */
			function updateAuthUI(){
				const username = localStorage.getItem('userName');
				const loginBtn = document.getElementById('loginBtn');
				const emailEl = document.getElementById('userEmail');
				if (username) {
					emailEl.textContent = username;
					loginBtn.textContent = 'Logout';
					loginBtn.removeAttribute('href');
					loginBtn.onclick = () => { localStorage.removeItem('userName'); updateAuthUI(); };
				} else {
					emailEl.textContent = '';
					loginBtn.textContent = 'Login';
					loginBtn.setAttribute('href', '/userLogin');
					loginBtn.onclick = null;
				}
			}

			/**
			 * load
			 * Fetches all movies from /api/movies and renders each as a row with poster, details, and review panel.
			 * After rendering list, triggers loading of reviews per title.
			 */
			async function load(){
				try {
					const res = await fetch('/api/movies');
					const entries = await res.json();
					const grid = document.getElementById('grid');
					if (!entries.length) { grid.innerHTML = '<p class="dim">No movies found.</p>'; return; }
					grid.innerHTML = entries.map((m) => {
						const title = m.title;
						const img = m.image ? `/Pictures/${m.image}` : (m.poster ? (m.poster.startsWith('/') ? m.poster : `/${m.poster}`) : '');
						const desc = m.description || '';
						const year = m.year ? `${m.year}` : '';
						const genre = m.genre || '';
						const director = m.director || '';
						return `
							<div class="row" data-title="${title}">
								${img ? `<img class=\"poster\" src=\"${img}\" alt=\"Poster for ${title}\" onerror=\"this.style.display='none'\" />` : `<div class=\"poster\"></div>`}
								<div class="details">
									<div class="title">${title}</div>
									<div class="sub">${[year, genre, director].filter(Boolean).join(' • ')}</div>
									<p class="desc">${desc}</p>
								</div>
								<div class="reviews">
									<div class="list" id="reviews-${encodeURIComponent(title)}"></div>
									<div class="form">
										<textarea rows="3" placeholder="Write a review..." id="text-${encodeURIComponent(title)}"></textarea>
										<div>
											<select id="rating-${encodeURIComponent(title)}">
												<option value="5">★★★★★</option>
												<option value="4">★★★★☆</option>
												<option value="3">★★★☆☆</option>
												<option value="2">★★☆☆☆</option>
												<option value="1">★☆☆☆☆</option>
											</select>
											<button type="button" onclick="submitReview('${encodeURIComponent(title)}')">Submit</button>
										</div>
									</div>
									<div class="msg" id="msg-${encodeURIComponent(title)}"></div>
								</div>
							</div>
						`;
					}).join('');
					for (const m of entries) { loadReviews(m.title); }
				} catch (e) {
					document.getElementById('grid').innerHTML = '<p class="dim">Failed to load catalog.</p>';
				}
			}

			/**
			 * loadReviews(title)
			 * Retrieves reviews for a given movie title and renders them.
			 * Fallback author display: username OR legacy email OR 'anon'.
			 */
			async function loadReviews(title){
				const list = document.getElementById(`reviews-${encodeURIComponent(title)}`);
				try {
					const res = await fetch(`/api/reviews?title=${encodeURIComponent(title)}`);
					const reviews = await res.json();
					if (!Array.isArray(reviews) || !reviews.length) { list.innerHTML = '<p class="dim">No reviews yet.</p>'; return; }
					list.innerHTML = reviews.map(r => `<p class=\"review\"><strong>${r.username || r.email || 'anon'}</strong> — ${'★'.repeat(r.rating)}${'☆'.repeat(5-r.rating)}<br/>${r.text || ''}</p>`).join('');
				} catch (err) {
					list.innerHTML = '<p class="dim">Failed to load reviews.</p>';
				}
			}

			/**
			 * submitReview(titleEnc)
			 * Posts a new review for a movie. Requires user to be logged in (localStorage userName).
			 * On success clears textarea and reloads review list; on failure shows error message.
			 */
			async function submitReview(titleEnc){
				const title = decodeURIComponent(titleEnc);
				const username = localStorage.getItem('userName');
				const msg = document.getElementById(`msg-${titleEnc}`);
				if (!username) { msg.textContent = 'Please log in to add a review.'; return; }
				const textEl = document.getElementById(`text-${titleEnc}`);
				const ratingEl = document.getElementById(`rating-${titleEnc}`);
				const payload = { title, username, text: textEl.value.trim(), rating: Number(ratingEl.value) };
				try {
					const res = await fetch('/api/reviews', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
					if (!res.ok) {
						const body = await res.json().catch(() => ({}));
						throw new Error((body.message || 'Failed to submit review') + (body.error ? ` — ${body.error}` : ''));
					}
					textEl.value = '';
					msg.textContent = 'Review submitted!';
					await loadReviews(title);
				} catch (err) {
					msg.textContent = err.message || 'Failed to submit review';
				}
			}

			/* Initialize page state */
			updateAuthUI();
			load();
		</script>
	</body>
	</html>
